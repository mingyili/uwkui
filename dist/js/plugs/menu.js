/*!
 * uwkui
 * Author: lmy
 * Version: 1.0.0
 * Last Update: 2017-01-19 06:03:18
 */
!function(a,b){"use strict";var c=function(b,d){return this.opt=a.extend({},c.def,d),this.$ele=a(b),this.init(),this};c.def={menuUrl:"",menuData:"",onSelect:function(a){},onAdd:function(a){},onOpen:function(b){a.popup(b)},onClose:function(b){a.closePopup(b)},dom:null,type:"",maxLen:0,checkedData:""},c.prototype={init:function(){this.lock=!1,this.inited=!1,this.mapData={},"checkbox"===this.opt.type&&1==this.opt.maxLen&&(this.opt.type="radio"),this.setMenu().getData().bindEvent()},setMenu:function(){return this.opt.dom=a(this.opt.dom),this.opt.dom&&0!==this.opt.dom.length||(this.opt.dom=a('<div class="popup menu"><div class="bar-header bg-wx"><h1 class="bar-title t-left"><i class="gray">选择分类</i></h1><a class="fr">'+("checkbox"===this.opt.type||"radio"===this.opt.type?'<i class="btn btn-mini btn-success j_add">新增</i>':"")+'<i class="btn close_menu btn-mini btn-default">取消</i></a></div>'+("checkbox"===this.opt.type?'<div class="bar-footer cell-item"><div class="item-inner check_info small"></div><a class="btn btn-fill j_save">确定</a></div>':"")+'<div class="content"><ul class="menu-list list-cont mt-none"></ul></div></div>').appendTo(a["default"].modalCont)),this.opt.domList=this.opt.dom.find(".menu-list"),"checkbox"===this.opt.type&&(this.opt.$checkInfo=this.opt.dom.find(".check_info")),this},isChecked:function(a){var b=this.opt.checkedData;return b?("object"!=typeof b&&(b=b.split(",")),b.length?b.map(function(a){return a==id||a.cid&&a.cid==id?!0:""}).join(""):b.cid==id):!1},setCheckData:function(){if("checkbox"!==this.opt.type){if(!this.inited){var b=this.opt.checkedData;b&&this.$ele.find(".result").text(this.mapData[b].listname),this.inited=!0}return this}var c=this.opt.dom.find(".j_menu:checked"),d=c.length,e=this,f=[];return 0!=this.opt.maxLen&&d>this.opt.maxLen?(a.toast("最多可选"+this.opt.maxLen+"个分类"),!1):(e.checkingData=[],c.each(function(b,c){var d=e.mapData[a(this).val()];e.checkingData.push(d),f.push(d.listname)}),f=f.join("，"),e.opt.$checkInfo.html(f?"已选："+f:'<i class="gray">请选择分类</i>'),f&&!this.inited&&this.$ele.find(".result").text(f),this.inited||(this.inited=!0),this)},getlistItem:function(a){return"radio"===this.opt.type?'<label class="cell-item cell-link"><p class="item-inner">'+a.listname+'</p><div class="item-after"><input value="'+a.cid+'" '+(this.isChecked(a.cid)?"checked":"")+' type="radio" class="j_menu input-radio" name="radio-menu"><i class="uicon-check"></i></div></label>':"checkbox"===this.opt.type?'<label class="cell-item cell-link"><p class="item-inner">'+a.listname+'</p><div class="item-after"><input value="'+a.cid+'" '+(this.isChecked(a.cid)?"checked":"")+' type="checkbox" class="j_menu input-check" name="check-menu"><i class="uicon-check"></i></div></label>':'<li class="cell-item j_menu cell-link" data-cid="'+a.cid+'"><i class="item-inner">'+a.listname+"</i>"+(a.prd_count?'<i class="tag btn-plain">'+a.prd_count+"</i>":"")+"</li>"},renderList:function(a){if(a?this.opt.menuData=a:a=this.opt.menuData,!a||0===a.length)return this.opt.domList.html('<li class="t-center pd-tb-big gray">暂无分类</li>'),this;var b=this;return this.opt.domList.html(a.map(function(a){return b.mapData[a.cid]=a,a.visible-0?a.sub&&a.sub.length?'<li class="cell-item j_open">'+a.listname+'</li><ul class="sub-menu">'+a.sub.map(function(a){return b.mapData[a.cid]=a,a.visible-0?b.getlistItem(a):""}).join("")+"</ul>":b.getlistItem(a):""}).join("")),this.opt.domList.find(".j_menu").length?this.setCheckData():this.opt.domList.html('<li class="t-center pd-tb-big gray">暂无分类</li>'),this},getData:function(){if(this.opt.menuData)return this.renderList(),this.delayOpen&&(this.open(),this.delayOpen=!1),this;if(this.lock)return this;this.lock=!0;var b=this;return a.loadStart(),a.ajax({type:"post",timeout:5e3,url:b.opt.menuUrl,complete:function(){a.loadEnd(),b.lock=!1},success:function(c){var d=JSON.parse(c);d.errcode?a.toast(d.errmsg):(b.renderList(d.data),b.delayOpen&&b.open())},error:function(b,c,d){"timeout"==c?a.toast("请求超时"):a.toast(c)}}),this},open:function(){return this.inited?this.renderList().opt.onOpen(this.opt.dom):this.delayOpen=!0,this},close:function(){return this.opt.onClose(this.opt.dom),this},select:function(b){var c=[];return b||this.opt.type?b&&0!==b.length?(this.opt.checkedData=b,this.$ele.data("result",b),b.length?this.$ele.find(".result").text(b.map(function(a){return c.push(a.cid),a.listname}).join("，")):(c.push(b.cid),this.$ele.find(".result").text(b.listname)),void(this.opt.onSelect.call(this,b,c)!==!1&&this.close())):(a.toast("请选择分类"),this):(this.$ele.find(".result").text("所有分类"),this.opt.onSelect.call(this,"")!==!1&&this.close(),this)},bindEvent:function(){var b=this;return this.opt.dom.on("click",".j_open",function(){a(this).next(".sub-menu").slideToggle()}).on("click",".close_menu",function(){b.close()}).on("click",".j_menu",function(){"radio"===b.opt.type?b.select(b.mapData[a(this).val()]):"checkbox"===b.opt.type?!b.setCheckData()&&(a(this)[0].checked=!1):b.select(b.mapData[a(this).data("cid")])}).on("click",".j_save",function(){b.select(b.checkingData)}).on("click",".j_add",function(){b.opt.onAdd(b)}),this}},a.fn.menu=function(b,d){return this.each(function(){var e=a(this),f=e.data("menu"),g=a.fn.menu.MenuData[f],h="object"==typeof b?b:{};g||(f=a.fn.menu.MenuData.index++,g=a.fn.menu.MenuData[f]=new c(this,h),e.data("menu",f)),"string"==typeof b&&g[b](d)})},a.fn.menu.MenuData={index:0},a.fn.menu.Constructor=c}($,window);