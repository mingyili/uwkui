/*!
 * uwkui
 * Author: lmy
 * Version: 1.0.0
 * Last Update: 2017-01-19 06:03:18
 */
!function(a,b){"use strict";var c,d={prdid:b.API.prdid||"",buyUrl:b.API.buyUrl||"",distype:b.API.distype||"",disnum:b.API.disnum||"",maxBuyNum:b.API.maxBuyNum||"",btns:"buy, cart",needFollow:!1,needOpen:!1,isFollow:b.API.isFollow},e={HOST:b.API.HOST,sid:b.API.sid,WexinUrl:b.API.WexinUrl||b.API.HOST+"/index.php/weixin/shop/show",dataUrl:b.API.dataUrl||b.API.HOST+"/index.php/weixin/shop/getprdsku",cartUrl:b.API.cartUrl||b.API.HOST+"/index.php/weixin/order/shoppingcart",zcUrl:b.API.zcUrl||b.API.HOST+"/index.php/weixin/order/order",$cnum:a("#cnum, .cnum")},f={},g=function(b,c){this.opt=a.extend({},d,c),this.opt.buyUrl=this.opt.buyUrl||e.WexinUrl+"?key=OrderConfirm",this.$ele=a(b),this.init()};g.version="1.0.0",g.lock=!1,g.prototype={init:function(){var b=this.opt.prdid;if(!b)return a.toast("没有商品id"),this;if(this.prdid=b,f[b])return this.trigger(),this;var c=this;return g.lock?this:(g.lock=!0,a.loadStart(),void a.ajax({type:"post",timeout:5e3,url:e.dataUrl,data:{prdid:b,sid:e.sid},complete:function(){a.loadEnd(),g.lock=!1},success:function(a){var b=JSON.parse(a);c.setData(b).trigger()},error:function(b,c,d){"timeout"==c?a.warning("请求超时"):a.warning(c)}}))},setData:function(a){return a.prdid=a.num_iid,a.link=this.opt.link,a.disnum=this.opt.disnum||0,2===a.acttype?"money"===a.disval.level.ActType?a.disnum=parseFloat(a.disval.level.DisMoney):"discount"===a.disval.level.ActType&&(a.disnum=parseFloat(10*a.disval.level.Discount)):3==a.acttype?2==a.disval.distype?(a.distype="discount",a.disnum=10*a.disval.Discount):3==a.disval.distype&&(a.distype="price",a.disnum=a.disval.DisMoney):a.distype=this.opt.distype||a.distype,"object"==typeof a.disnum&&(a.distype=""),a.is_sku=JSON.parse(a.is_sku),a.is_sku&&this.mapSkuData(a),f[this.prdid]=a,this},setBtnData:function(){var a=this,b=this.opt.btns,c=[];return"string"==typeof b&&(b.indexOf("buy")>-1&&c.push({type:"buy",style:"btn-danger",text:"立即购买",onClick:function(b){a.onBuy(b)}}),b.indexOf("cart")>-1&&c.push({type:"cart",style:"btn-default",text:"加入购物车",onClick:function(b){a.onCart(b)}}),b.indexOf("zc")>-1&&(a.opt.needOpen=!0,c.push({type:"zc",style:"btn-danger",text:"立即众筹",onClick:function(b){a.onZc(b)}})),this.opt.btns=c),this},trigger:function(){"string"==typeof this.opt.btns&&this.setBtnData();var b,c,d=this.opt.btns,e=d.length;return this.opt.prdid?void(e&&1!==e?e>1&&this.open():(c=e?d[0]:d,c.text="确定",c.style="btn-danger",this.opt.needOpen?this.open():(b=this.getBuyData(),b&&c.onClick(b)))):(a.toast("没有商品id"),this)},getBuyData:function(){if(this.opt.needFollow&&!this.opt.isFollow)return a.follow(),!1;var d,e=f[this.prdid];if("unsale"==e.unsale?d="对不起，该商品已下架":0==e.prd_num&&(d="对不起，该商品已售罄"),d)return a.toast(d),!1;var g,h=!c||"none"==c.$cont.css("display")||c.$cont.hasClass("out"),i={};if(e.is_sku)if(e.isOneSku)i.skuid=e.is_sku.sku_id;else{if(h)return this.open(),!1;if(g=this.getSkuData(),"string"==typeof g)return a.toast(g),!1;i.skuid=g.sku_id}return i.buynum=c&&c.$cont.data("nowid")==e.prdid&&c.$buy_number.val()||1,i.prdid=e.prdid,i.sina_uid=e.sina_uid,i.buyTail=b.API.buyTail||b.buy_tail||"",this.close(),a.loadStart(),i},open:function(){return c||this.setSkuDom(),c.$cont.data("nowid")!=this.prdid&&this.render(),this.setBtnDom(),a.popup(c.$cont),this},render:function(){var d=f[this.prdid];if(c.$prd_title.text(d.title),this.changeImg(d.pic_url+"_180x180.jpg"),d.link?c.$prd_link.attr("href",d.link):(c.$prd_link.attr("href","javascript:void(0)"),c.$prd_img.attr("name","view_"+this.prdid),c.$prd_img.viewImg("setUrls",d.imgs||d.pic_url)),this.changePrice(d.price),"discount"==d.distype?c.$prd_dis.html(d.disnum+"折").show():"price"==d.distype?c.$prd_dis.html("立减￥"+d.disnum).show():c.$prd_dis.hide(),c.$buy_number.val(1),this.changeQuantity(d.prd_num),d.is_sku&&d.prdsku?(c.$sku_cont.html(d.prdsku).show(),this.bindSkuEvent(),d.skuType.map(function(b){var c=a('input[name="'+b+'"]:not([disabled])').eq(0);c[0]&&(c[0].checked=!0,c.trigger("change"))})):c.$sku_cont.hide(),(1==d.wbulk||1==d.is_presell)&&window.location.href.indexOf("?key=ShowPrd:")<0)return b.top.location.href=e.WexinUrl+"?key=ShowPrd:"+d.prdid+"&sid="+e.sid,this;var g;return"unsale"==d.unsale?g="商品已下架":0==d.prd_num&&(g="商品已售罄"),g?(c.$btns_sell.hide(),c.$btns_unsell.css("display","-webkit-flex").find(".btn").text(g)):(c.$btns_unsell.hide(),c.$btns_sell.css("display","-webkit-flex")),c.$cont.data("nowid",d.prdid),this},close:function(){c&&a.closePopup(c.$cont)},setSkuDom:function(){var b='<div class="popup selectsku-block skuselect" id="J_sku"><div class="select-close-cont close-popup"></div><div class="selectsku-cont"><div class="list-cont skuprd-cont"><a class="list-item prd_link"><div class="item-img"><img class="prd_img view_img" src="" name="skuimgs" alt="商品图片"></div><div class="item-inner"><div class="item-title"><i class="tag bg-danger r-small prd_dis"></i> <span class="prd_title"></span></div><big class="danger prd_price"><i class="small">￥</i>00.00</big><small class="old_price"><i class="small">￥</i>00.00</small></div><div class="item-after item-fill cell-link close-popup"><big class="icon-close icon_close"></big></div></a></div><div class="scroll-cont"><div class="sku_cont border-b"></div><div class="list-item"><span class="item-inner">购买数量(库存<i class="prd_quantity">0</i>件)：</span><div class="input-number"><i class="uicon-minus btn_minus"></i><input class="input-num buy_number" type="quantity" value="1" max="" min="1" readonly="readonly"><i class="uicon-add btn_add"></i></div></div><div class="mt-base"></div></div><div class="bar-footer btns-inline btns-sell"><a class="btn btn-fill disabled">立即购买</a></div><div class="bar-footer btns-inline btns-unsell" hidden><a class="btn btn-fill disabled">不能购买</a></div></div></div>',d=a(b);a(document.body).append(d),c={$cont:d,$prd_link:d.find(".prd_link"),$prd_img:d.find(".prd_img"),$prd_dis:d.find(".prd_dis"),$prd_title:d.find(".prd_title"),$prd_price:d.find(".prd_price"),$old_price:d.find(".old_price"),$prd_quantity:d.find(".prd_quantity"),$sku_cont:d.find(".sku_cont"),$buy_number:d.find(".buy_number"),$btns_sell:d.find(".btns-sell"),$btns_unsell:d.find(".btns-unsell")},c.$buy_number.quantity("reset",!0)},changeImg:function(a){return a&&c.$prd_img.attr("src",a),this},changePrice:function(a,b){var d=f[this.prdid],e=parseFloat(a);return b=b||1,isNaN(e)||"discount"!=d.distype&&"price"!=d.distype?c.$old_price.hide():c.$old_price.html("￥"+e.toFixed(2)).show(),isNaN(e)?c.$prd_price.html(a):("price"==d.distype?e=e*b-d.disnum:"discount"==d.distype&&(e*=b*d.disnum*.1),e=0>e?0:e,c.$prd_price.html('<i class="small">￥</i>'+e.toFixed(2))),this},changeQuantity:function(a){return c.$prd_quantity.text(a),a>=1?(this.opt.maxBuyNum&&(a=Math.min(this.opt.maxBuyNum,a)),c.$buy_number.attr({max:a,min:"1"}).change(),c.$btns_sell.find(".btn").removeClass("btn-hold")):(c.$buy_number.attr({max:"0",min:"0"}).change(),c.$btns_sell.find(".btn").addClass("btn-hold")),this},setBtnDom:function(){var b=c.$btns_sell,d=this,e=this.opt.btns,f=e.length,g=a();return this.$btns?g=this.$btns:f?e.map(function(b){g=g.add(a('<a class="btn btn-fill '+b.type+" "+b.style+'">'+b.text+"</a>"))}):g=a('<a class="btn btn-fill '+e.type+" "+e.style+'">'+e.text+"</a>"),b.html(g),g.off("click").on("click",function(){if(!a(this).hasClass("btn-hold")){var b=f?e[a(this).index()]:e,c=d.getBuyData();c&&b.onClick&&b.onClick(c)}}),this.$btns=g,this},getSkuHtml:function(b){var c={};return a.each(b.property_alias,function(a,b){c[b.typename]||(c[b.typename]=[]);var d=b.num||b.quantity?"":"disabled",e='<label><input type="radio" value="'+a+'" name="'+b.typename+'" '+d+' hidden/><span class="span">'+b.val+"</span></label>";c[b.typename].push(e)}),b.skuType.map(function(a){return'<div class="cont-block"><p class="cont-title">'+a+":</p>"+c[a].join(" ")+"</div>"}).join("\n")},bindSkuEvent:function(){var a=this;c.$sku_cont.find("input:not([disabled])").on("change",function(){var b=a.getSkuData();b&&"object"==typeof b&&a.changeImg(b.props_img).changePrice(b.price).changeQuantity(b.quantity)})},getSkuData:function(){var b,c,d=f[this.prdid];return b=d.skuType.map(function(b){var d=a('input[name="'+b+'"]:checked');return d.length<1&&(c="请选择"+b),d.val()}).join(";"),c?c:d.isOneSku?d.is_sku:d.is_sku[b]||{price:"暂无产品报价",props_img:d.pic_url+"_180x180.jpg",quantity:0,sku_id:0}},mapSkuData:function(a){var b=a.is_sku.length,c=a.propertie||[],d={},e=[],f={};return a.isOneSku=!b||1===b,a.propertie1&&c.push(a.propertie1),a.propertie2&&c.push(a.propertie2),a.propertie3&&c.push(a.propertie3),a.skuType=c,a.sku_dif_arr.map(function(b){var c=b.c_id&&"c_"||b.s_id&&"s_"||b.sku_c1_id&&"sku_c1_",d=b[c+"id"]&&b[c+"typeid"]+":"+b[c+"id"];d&&(f[d]={},f[d].typename=b[c+"typename"],f[d].val=b[c+"name"]||b[c+"num"],f[d].num=a.isOneSku?a.is_sku.quantity:0)}),a.property_alias.map(function(a){f[a.property]&&(f[a.property].val=a.val)}),a.isOneSku||(a.is_sku.map(function(a){d[a.properties]={},d[a.properties].price=a.price||"暂无产品报价",d[a.properties].props_img=a.props_img||"",d[a.properties].quantity=a.quantity||0,d[a.properties].sku_id=a.sku_id||0,a.props_img&&e.push(a.props_img),a.properties.split(";").map(function(b){f[b]&&(f[b].num+=parseInt(a.quantity,10))})}),a.is_sku=d),a.imgs=e.length>0?e:"",a.property_alias=f,a.prdsku=this.getSkuHtml(a),this},onBuy:function(a){var c=this.opt;a.skuid?b.top.location.href=c.buyUrl+":"+a.skuid+":"+a.buynum+":"+a.prdid+":1:&sid="+e.sid+a.buyTail:b.top.location.href=c.buyUrl+":0:"+a.buynum+":"+a.prdid+":0:&sid="+e.sid+a.buyTail},onCart:function(c,d){var f=this;return c.sina_uid?void a.ajax({type:"POST",url:e.cartUrl,data:{prd_id:c.prdid,sku_id:c.skuid,buy_num:c.buynum,sid:e.sid,cid:f.opt.cid},success:function(b){a.loadEnd();var c=JSON.parse(b);parseInt(c.seller,10)>0&&(a.success("已加入购物车",800),e.$cnum.parent().show(),e.$cnum.html(c.seller).animate("heartpop"))}}):(b.top.location.href=c.OauthUrl,this)},onZc:function(a){var c=e.zcUrl+"?num="+a.buynum+"&num_iid="+a.prdid+"&is_donation=0&paid_type=2&helpbuy=2&sid="+e.sid+a.buyTail;a.skuid&&(c+="&sku_id="+a.skuid),b.top.location.href=c}},a.fn.selectSku=function(b){return this.each(function(){var c=a(this),d=c.data("skuData"),e=a.fn.selectSku.skuData[d],f="object"==typeof b?b:{},h=c.attr("prdid"),i=c.attr("type"),j=c.attr("prdlink"),k=c.hasClass("needFollow"),l=c.hasClass("needOpen");h&&!f.prdid&&(f.prdid=h),i&&!f.btns&&(f.btns=i),j&&!f.link&&(f.link=j),k&&!f.needFollow&&(f.needFollow=k),l&&!f.needOpen&&(f.needOpen=l),e?e.trigger():(d=a.fn.selectSku.skuData.index++,e=a.fn.selectSku.skuData[d]=new g(this,f),c.data("skuData",d)),"string"==typeof b&&e[b]()})},a.fn.selectSku.skuData={index:0},a.fn.selectSku.Constructor=g,a(document).on("click",".ywk-diybuy",function(b){a(this).selectSku()})}($,window);