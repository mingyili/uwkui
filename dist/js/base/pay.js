
/*!
 * uwkui
 * Author: lmy
 * Version: 1.0.0
 * Last Update: 2017-03-22 02:36:36
 */
!function(a,b){"use strict";function c(){if(e)return this;e=!0;var b=this;a.ajax({type:"POST",url:b.opt.orderInfoUrl,data:{tid:b.opt.tid},success:function(c){e=!1,"string"==typeof c&&(c=a.parseJSON(c)),100001==c.code?b.fail(c.msg):1e5==c.code&&b.success()}})}a(document).on("change",".pay_type",function(){var b=a(this).val();a("."+b).show().siblings().hide(),a(".btn_pay").data("type",b)});var d=a(".pay_type:checked");!d.length&&b.defPayType&&(d=a('.pay_type[value="'+b.defPayType+'"]')),d.length&&(d[0].checked=!0,d.trigger("change")),1===a(".pay_type").length&&a(".pay_type_cont").hide();var e=!1,f=function(b,c){return this.opt=a.extend({},f.def,c),this.$ele=a(b),this.init(),this};f.def={bindClick:!0,tid:"",payDataUrl:"",orderInfoUrl:"",successUrl:"",wxPay:function(){this.getPayData(this.opt.payDataUrl,function(a){var b=this,d=a.pay_data,e=a.user_agent||navigator.userAgent,f=e.match(/MicroMessenger\/(\d+(\.\d+)*)/),g=e.match(/Windows Phone/);return g||f&&!(parseFloat(f[1],10)<5)?(b.$ele.html("微信安全支付..."),void WeixinJSBridge.invoke("getBrandWCPayRequest",d,function(a){var d=a.err_msg;"get_brand_wcpay_request:ok"===d?b.success():"get_brand_wcpay_request:fail"===d?b.fail("支付失败，请重新尝试！"):"get_brand_wcpay_request:cancel"===d?b.cancel():c.call(b)})):b.fail("您的微信版本低于5.0，不支持“微信安全支付”!")})}},f.prototype={init:function(){this.lock=!1,this.opt.bindClick&&this.$ele.off("click").on("click",this.pay.bind(this))},start:function(){return this.opt.tid?this.lock?this:(this.$ele.html("等待支付...").addClass("btn-hold"),void(this.lock=!0)):this.fail("找不到要支付的订单号")},success:function(){a.success("支付成功"),this.$ele.html("支付成功，正在处理订单...");var b=this.opt;b.success?b.success.call(this):setTimeout(function(){window.location.href=b.successUrl},200)},end:function(){a.loadEnd(),this.$ele.html("立即支付").removeClass("btn-hold"),this.lock=!1},cancel:function(){this.end(),a.toast("您已取消支付"),this.opt.cancel&&this.opt.cancel.call(this)},fail:function(b){this.end(),this.opt.fail?this.opt.fail.call(this,b):b&&a.alert(b,function(){window.location.reload()})},getPayData:function(b,c){var d=this;a.ajax({type:"POST",url:b,data:{tid:d.opt.tid},success:function(b){return b?("string"==typeof b&&(b=a.parseJSON(b)),void(1==b.code?d.fail(b.errmsg):c&&c.call(d,b))):d.fail("返回数据有误")},error:function(b,c,e){d.fail(),a.toast(c)}})},pay:function(b,c){"object"==typeof b&&b.currentTarget&&(b=a(b.currentTarget).data("type"));var d=this.opt,e=d[(b||"wx")+"Pay"];if(d.tid=c||d.tid,e){if(this.start())return this;e.call(this)}else a.toast("请指定支付方式")}},a.fn.pay=function(b,c,d){return this.each(function(){var e=a(this),g=e.data("pay"),h=a.fn.pay.payData[g],i="object"==typeof b?b:{};h||(g=a.fn.pay.payData.index++,h=a.fn.pay.payData[g]=new f(this,i),e.data("pay",g)),"string"==typeof b&&h[b](c,d)})},a.fn.pay.payData={index:0},a.fn.pay.Constructor=f}($,window);